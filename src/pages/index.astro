---
/**
 * ä¸»æ£€æµ‹ç•Œé¢
 * é›†æˆæ³¢å½¢æ˜¾ç¤ºå’Œå®æ—¶æ•°æ®é‡‡é›†
 */

import MainLayout from '@/layouts/MainLayout.astro';

const title = 'å®æ—¶ä¸‰æ¢å¤´ç£ç²‰æ£€æµ‹ - æ¥è§¦å¼ä¸‰æ¢å¤´ç£æ£€æµ‹è½¯ä»¶';
const description = 'ä¸“ä¸šçš„å·¥ä¸šçº§ç£ç²‰æ£€æµ‹ç³»ç»Ÿä¸»æ£€æµ‹ç•Œé¢ï¼Œå®æ—¶æ˜¾ç¤ºä¸‰æ¢å¤´æ³¢å½¢æ•°æ®ï¼Œç²¾ç¡®ç›‘æµ‹å·¥ä»¶è¡¨é¢ç¼ºé™·ã€‚æ”¯æŒåœ¨çº¿çŠ¶æ€ç›‘æ§ã€å‚æ•°è°ƒèŠ‚ã€æ³¢å½¢åˆ†æç­‰åŠŸèƒ½ã€‚é‡‡ç”¨30fps+é«˜æ€§èƒ½Canvasæ¸²æŸ“ï¼Œå»¶è¿Ÿå°äº100msã€‚';
const keywords = 'ç£ç²‰æ£€æµ‹,ä¸‰æ¢å¤´æ£€æµ‹,å®æ—¶æ³¢å½¢æ˜¾ç¤º,ç¼ºé™·æ£€æµ‹,NDTæ£€æµ‹,æ— æŸæ£€æµ‹ç³»ç»Ÿ,å·¥ä¸šæ£€æµ‹è½¯ä»¶,æ¢å¤´ç›‘æ§,å®æ—¶æ•°æ®é‡‡é›†';
---

<MainLayout 
  title={title}
  description={description}
  keywords={keywords}
>
  <div class="h-full flex flex-col p-6">
    <!-- æ³¢å½¢æ˜¾ç¤ºåŒº -->
    <div class="flex-1 panel mb-4">
      <div class="panel-header flex items-center justify-between">
        <h2>å®æ—¶æ³¢å½¢æ˜¾ç¤º</h2>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2">
            <input type="checkbox" class="checkbox" id="showGrid" checked />
            <span class="text-sm">æ˜¾ç¤ºç½‘æ ¼</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="checkbox" id="showPeaks" checked />
            <span class="text-sm">æ˜¾ç¤ºå³°å€¼</span>
          </label>
          <button class="btn-sm btn-secondary" id="zoomIn">æ”¾å¤§</button>
          <button class="btn-sm btn-secondary" id="zoomOut">ç¼©å°</button>
          <button class="btn-sm btn-secondary" id="resetZoom">é‡ç½®</button>
        </div>
      </div>
      
      <!-- Canvasæ³¢å½¢æ˜¾ç¤º -->
      <div class="h-full min-h-[400px] bg-bg-primary rounded mt-4 relative">
        <canvas 
          id="waveform-canvas" 
          class="w-full h-full"
        >
        </canvas>
      </div>
    </div>
    
    <!-- æ¢å¤´ä¿¡æ¯å’Œå‚æ•°æ˜¾ç¤ºåŒº -->
    <div class="grid grid-cols-3 gap-4">
      <!-- æ¢å¤´1 -->
      <div class="panel">
        <div class="flex items-center gap-2 mb-3">
          <span class="status-indicator status-online" id="probe1-status"></span>
          <h3 class="text-lg font-semibold text-accent-primary">æ¢å¤´ 1</h3>
        </div>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-text-secondary">å¢ç›Š:</span>
            <span class="font-semibold" id="probe1-gain">45.5 dB</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">é¢‘ç‡:</span>
            <span class="font-semibold" id="probe1-freq">5.0 MHz</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">é˜ˆå€¼:</span>
            <span class="font-semibold" id="probe1-threshold">50%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">æœ€å¤§å€¼:</span>
            <span class="font-semibold text-accent-success" id="probe1-max">0.00 V</span>
          </div>
        </div>
      </div>
      
      <!-- æ¢å¤´2 -->
      <div class="panel">
        <div class="flex items-center gap-2 mb-3">
          <span class="status-indicator status-online" id="probe2-status"></span>
          <h3 class="text-lg font-semibold text-accent-primary">æ¢å¤´ 2</h3>
        </div>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-text-secondary">å¢ç›Š:</span>
            <span class="font-semibold" id="probe2-gain">45.5 dB</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">é¢‘ç‡:</span>
            <span class="font-semibold" id="probe2-freq">5.0 MHz</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">é˜ˆå€¼:</span>
            <span class="font-semibold" id="probe2-threshold">50%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">æœ€å¤§å€¼:</span>
            <span class="font-semibold text-accent-success" id="probe2-max">0.00 V</span>
          </div>
        </div>
      </div>
      
      <!-- æ¢å¤´3 -->
      <div class="panel">
        <div class="flex items-center gap-2 mb-3">
          <span class="status-indicator status-online" id="probe3-status"></span>
          <h3 class="text-lg font-semibold text-accent-primary">æ¢å¤´ 3</h3>
        </div>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-text-secondary">å¢ç›Š:</span>
            <span class="font-semibold" id="probe3-gain">45.5 dB</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">é¢‘ç‡:</span>
            <span class="font-semibold" id="probe3-freq">5.0 MHz</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">é˜ˆå€¼:</span>
            <span class="font-semibold" id="probe3-threshold">50%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">æœ€å¤§å€¼:</span>
            <span class="font-semibold text-accent-success" id="probe3-max">0.00 V</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  // æ³¢å½¢æ˜¾ç¤ºå’Œæ•°æ®æ¨¡æ‹Ÿ
  import { DataSimulator } from '../lib/dataSimulator';
  
  let isRecording = false;
  let simulator: DataSimulator | null = null;
  let canvas: HTMLCanvasElement | null = null;
  let ctx: CanvasRenderingContext2D | null = null;
  
  // æ³¢å½¢æ•°æ®ç¼“å­˜
  const waveformData = {
    probe1: [] as number[],
    probe2: [] as number[],
    probe3: [] as number[],
  };
  
  // æ˜¾ç¤ºé…ç½®
  const config = {
    timeScale: 1.0,
    amplitudeScale: 1.0,
    showGrid: true,
    showPeaks: true,
  };
  
  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    canvas = document.getElementById('waveform-canvas') as HTMLCanvasElement;
    if (!canvas) return;
    
    ctx = canvas.getContext('2d');
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // åˆå§‹æ˜¾ç¤º
    drawWaveform();
    
    // ç»‘å®šæ§åˆ¶æŒ‰é’®ï¼ˆæ¥è‡ªå¸ƒå±€ï¼‰
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.querySelector('[data-action="start"]');
    document.querySelector('[data-action="stop"]');
    
    // æ˜¾ç¤ºé…ç½®
    document.getElementById('showGrid')?.addEventListener('change', (e) => {
      config.showGrid = (e.target as HTMLInputElement).checked;
      drawWaveform();
    });
    
    document.getElementById('showPeaks')?.addEventListener('change', (e) => {
      config.showPeaks = (e.target as HTMLInputElement).checked;
      drawWaveform();
    });
    
    document.getElementById('zoomIn')?.addEventListener('click', () => {
      config.amplitudeScale *= 1.2;
      drawWaveform();
    });
    
    document.getElementById('zoomOut')?.addEventListener('click', () => {
      config.amplitudeScale /= 1.2;
      drawWaveform();
    });
    
    document.getElementById('resetZoom')?.addEventListener('click', () => {
      config.amplitudeScale = 1.0;
      config.timeScale = 1.0;
      drawWaveform();
    });
    
    // ğŸ¯ è‡ªåŠ¨å¼€å§‹æ£€æµ‹ - é¡µé¢åŠ è½½åå»¶è¿Ÿ500msè‡ªåŠ¨å¯åŠ¨
    setTimeout(() => {
      (window as any).startDetection();
      console.log('âœ… è‡ªåŠ¨æ£€æµ‹å·²å¯åŠ¨');
    }, 500);
  });
  
  // å…¨å±€å‡½æ•°ä¾›å¸ƒå±€è°ƒç”¨
  (window as any).startDetection = () => {
    if (isRecording) return;
    
    isRecording = true;
    simulator = new DataSimulator();
    
    simulator.start((probe, data) => {
      const key = `probe${probe}` as 'probe1' | 'probe2' | 'probe3';
      waveformData[key] = data;
      
      // æ›´æ–°æ˜¾ç¤º
      drawWaveform();
      updateProbeStats(probe, data);
    }, true); // true = å¯èƒ½åŒ…å«ç¼ºé™·
    
    console.log('æ£€æµ‹å·²å¼€å§‹');
  };
  
  (window as any).stopDetection = () => {
    if (!isRecording) return;
    
    isRecording = false;
    simulator?.stop();
    
    // æ¸…ç©ºæ•°æ®
    waveformData.probe1 = [];
    waveformData.probe2 = [];
    waveformData.probe3 = [];
    
    drawWaveform();
    console.log('æ£€æµ‹å·²åœæ­¢');
  };
  
  function resizeCanvas() {
    if (!canvas) return;
    const parent = canvas.parentElement;
    if (!parent) return;
    
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;
    drawWaveform();
  }
  
  function drawWaveform() {
    if (!ctx || !canvas) return;
    
    const w = canvas.width;
    const h = canvas.height;
    
    // æ¸…ç©ºç”»å¸ƒ
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, w, h);
    
    // ç»˜åˆ¶ç½‘æ ¼
    if (config.showGrid) {
      drawGrid(ctx, w, h);
    }
    
    // ç»˜åˆ¶ä¸‰æ¡æ³¢å½¢
    const colors = ['#ff8c00', '#00ff00', '#00ccff'];
    const probeData = [waveformData.probe1, waveformData.probe2, waveformData.probe3];
    
    if (ctx) {
      probeData.forEach((data, index) => {
        if (data.length === 0 || !ctx) return;
        
        const yOffset = (index + 1) * h / 4;
        const scale = (h / 8) * config.amplitudeScale;
        
        ctx.strokeStyle = colors[index] || '#ff8c00';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        data.forEach((value, i) => {
          if (!ctx) return;
          const x = (i / data.length) * w * config.timeScale;
          const y = yOffset - value * scale;
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        
        ctx.stroke();
        
        // ç»˜åˆ¶æ¢å¤´æ ‡ç­¾
        ctx.fillStyle = colors[index] || '#ff8c00';
        ctx.font = '14px system-ui';
        ctx.fillText(`æ¢å¤´ ${index + 1}`, 10, yOffset - 60);
        
        // æ˜¾ç¤ºå³°å€¼
        if (config.showPeaks && data.length > 0) {
          const max = Math.max(...data);
          const min = Math.min(...data);
          ctx.font = '12px system-ui';
          ctx.fillText(`Max: ${max.toFixed(2)}V`, 10, yOffset - 40);
          ctx.fillText(`Min: ${min.toFixed(2)}V`, 10, yOffset - 25);
        }
      });
    }
  }
  
  function drawGrid(ctx: CanvasRenderingContext2D, w: number, h: number) {
    ctx.strokeStyle = '#2a2a2a';
    ctx.lineWidth = 1;
    
    for (let x = 0; x < w; x += 50) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, h);
      ctx.stroke();
    }
    
    for (let y = 0; y < h; y += 50) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(w, y);
      ctx.stroke();
    }
  }
  
  function updateProbeStats(probe: number, data: number[]) {
    if (data.length === 0) return;
    
    const max = Math.max(...data);
    const maxEl = document.getElementById(`probe${probe}-max`);
    if (maxEl) {
      maxEl.textContent = `${max.toFixed(2)} V`;
    }
  }
</script>